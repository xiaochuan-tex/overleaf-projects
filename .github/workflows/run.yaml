name: Compile LaTeX Projects

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:
  push:

jobs:
  compile-projects:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: 
          # - name: "26李艳芳900题"
          #   url: "https://www.overleaf.com/project/6938153fa7bfe48a96682edd/download/zip"
          # - name: "26李林880题"
          #   url: "https://www.overleaf.com/project/693952b82ab4edb0635d9a6d/download/zip"
          # - name: "26武忠祥高数严选题"
          #   url: "https://www.overleaf.com/project/69426cb371b752e36a043752/download/zip"
          # - name: "26周洋鑫考点全刷800题"
          #   url: "https://www.overleaf.com/project/694273ca0004cd133c015538/download/zip"
          # - name: "26数据结构做题本"
          #   url: "https://www.overleaf.com/project/693c1bd1b7757c632e5994dc/download/zip"
          # - name: "26操作系统做题本"
          #   url: "https://www.overleaf.com/project/693e433b3844a5658596ea38/download/zip"
          # - name: "26计组做题本"
          #   url: "https://www.overleaf.com/project/695604664269680786fd1eb2/download/zip"
          # - name: "26计网做题本"
          #   url: "https://www.overleaf.com/project/69562d74426968078605fec3/download/zip"
          # - name: "24数学模拟卷"
          #   url: "https://www.overleaf.com/project/69510f5b2a2da77347ae2c01/download/zip"
          #   sub: true
          # - name: "25数学模拟卷"
          #   url: "https://www.overleaf.com/project/695c75ec0dc61c016dfe9644/download/zip"
          #   sub: true
          # - name: "26数学模拟卷"
          #   url: "https://www.overleaf.com/project/695c76428d7895ec31ce2b07/download/zip"
          #   sub: true
          # - name: "数学历年真题"
          #   url: "https://www.overleaf.com/project/69526b934d1938e26c9773a3/download/zip"
          #   sub: true
          # - name: '计算机历年真题'
          #   url: 'https://www.overleaf.com/project/69623fdc0818cdd3f98a1e7d/download/zip'
          #   sub: true
          #   c: true
          - name: "线性代数陈建龙"
            url: "https://www.overleaf.com/project/694a85dbedca3140fd82fa92/download/zip"
          - name: "茆书概率论"
            url: "https://www.overleaf.com/project/695098b32c6528541a5d30a4/download/zip"
          - name: "黄炜概率论"
            url: "https://www.overleaf.com/project/695519924fd1d15c372fa6eb/download/zip"
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      
      - name: Clone source
        run: |
          PROJECT_NAME="${{ matrix.project.name }}"
          PROJECT_URL="${{ matrix.project.url }}"
          
          curl -H "Cookie: ${{ secrets.COOKIE }}" "$PROJECT_URL" -o "$PROJECT_NAME.zip"
          unzip "./$PROJECT_NAME.zip" -d "./$PROJECT_NAME"

      - name: Setup compile script for sub projects
        run: |
          PROJECT_NAME="${{ matrix.project.name }}"
          
          # 复制当前目录下的 scripts/compile.py 到项目目录
          echo "复制 scripts/compile.py 到 ./$PROJECT_NAME/"
          cp "scripts/compile.py" "./$PROJECT_NAME/compile.py"
          chmod +x "./$PROJECT_NAME/compile.py"
          
          # 列出文件确认
          echo "复制完成，项目目录内容："
          ls -la "./$PROJECT_NAME/"

      - name: Fix permissions for caching
        run: |
          sudo mkdir -p /usr/local/texlive/2025
          sudo chown -R $USER:$USER /usr/local/texlive/2025
          sudo chmod -R 755 /usr/local/texlive/2025

      - name: Cache downloaded file
        uses: actions/cache@v4
        id: cache-software
        with:
          path: /usr/local/texlive/2025
          key: ${{ runner.os }}-texlive2025

      - name: install texlive
        if: steps.cache-software.outputs.cache-hit != 'true'
        run: |
          cd /tmp
          curl -O https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/Images/texlive2025.iso
          sudo mkdir -p /mnt/texlive2025
          sudo mount -o loop,ro /tmp/texlive2025.iso /mnt/texlive2025
          cd /mnt/texlive2025
          sudo ./install-tl --scheme=full --no-interaction

      - name: Install fonts
        if: steps.cache-fonts.outputs.cache-hit != 'true'
        run: |
          sudo apt update
          sudo apt install -y fonts-noto-cjk fonts-arphic-gkai00mp
          fc-cache -fv

      - name: Compile LaTeX
        run: |
          export PATH=$PATH:/usr/local/texlive/2025/bin/x86_64-linux
          PROJECT_NAME="${{ matrix.project.name }}"
          IS_SUB="${{ matrix.project.sub || 'false' }}"
          IS_C="${{ matrix.project.c || 'false' }}"
          
          cd "./$PROJECT_NAME"
          
          # 尝试编译
          if [ -f "main.tex" ]; then
            latexmk -xelatex -quiet -time -jobname="$PROJECT_NAME" main.tex
            cp ./*.pdf ../
          fi
          if [ -f "pad.tex" ]; then
            latexmk -xelatex -quiet -time -jobname="${PROJECT_NAME}_pad" pad.tex
            cp ./*.pdf ../
          fi
          if [ -f "compile.py" ]; then
            python ./compile.py --sub="$IS_SUB" --c="$IS_C"
            echo "复制所有 PDF 文件到上级目录..."
            find . -name "*.pdf" -type f -exec cp {} ../ \;
          fi

      - name: Upload PDF
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.project.name }}
          path: ./*.pdf
          retention-days: 2

  collect-all-pdfs:
    runs-on: ubuntu-latest
    needs: compile-projects
    steps:
      - uses: actions/checkout@v5
      - name: Install GitHub CLI
        run: |
          type gh >/dev/null 2>&1 || { 
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          }
      
      - name: Download all artifacts using gh cli
        run: |
          mkdir -p ./all-pdfs
          export GH_REPO=${{ github.repository }}
          
          # 获取所有artifact的ID和名称
          artifacts=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" --jq '.artifacts[] | {id: .id, name: .name}')
          
          echo "找到以下artifacts:"
          echo "$artifacts" | jq -r '.name'
          echo ""
          
          # 逐个下载每个artifact，使用ID而不是名称
          echo "$artifacts" | jq -c '.' | while read -r artifact; do
            name=$(echo "$artifact" | jq -r '.name')
            id=$(echo "$artifact" | jq -r '.id')
            
            echo "正在下载: $name (ID: $id)"
            
            # 使用ID下载，避免URL过期问题
            gh api "/repos/${{ github.repository }}/actions/artifacts/$id/zip" > "./temp.zip"
            
            if [ $? -eq 0 ]; then
              # 创建目标目录
              mkdir -p "./all-pdfs/$name"
              
              # 解压到对应目录
              unzip -q "./temp.zip" -d "./all-pdfs/$name"
              rm "./temp.zip"
              echo "✅ 完成: $name"
            else
              echo "❌ 失败: $name"
            fi
            
            echo ""
            sleep 2
          done
          
          echo "所有下载完成！"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: List all PDFs
        run: |
          echo "所有编译完成的PDF文件："
          find ./all-pdfs -name "*.pdf" | sort
          
      - name: Create consolidated artifact
        uses: actions/upload-artifact@v6
        with:
          name: all-latex-projects-pdfs
          path: ./all-pdfs/
          retention-days: 2