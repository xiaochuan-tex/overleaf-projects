name: Compile LaTeX Projects
permissions: write-all
on:
  schedule:
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
  push:

jobs:
  compile-projects:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: 
          - name: "26李艳芳900题"
            url: "https://www.overleaf.com/project/6938153fa7bfe48a96682edd/download/zip"
          - name: "26李林880题"
            url: "https://www.overleaf.com/project/693952b82ab4edb0635d9a6d/download/zip"
          - name: "26武忠祥高数严选题"
            url: "https://www.overleaf.com/project/69426cb371b752e36a043752/download/zip"
          - name: "26周洋鑫考点全刷800题"
            url: "https://www.overleaf.com/project/694273ca0004cd133c015538/download/zip"
          - name: "26数据结构做题本"
            url: "https://www.overleaf.com/project/693c1bd1b7757c632e5994dc/download/zip"
          - name: "26操作系统做题本"
            url: "https://www.overleaf.com/project/693e433b3844a5658596ea38/download/zip"
          - name: "24数学模拟卷"
            url: "https://www.overleaf.com/project/69510f5b2a2da77347ae2c01/download/zip"
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13' 
      
      - name: Clone source
        run: |
          PROJECT_NAME="${{ matrix.project.name }}"
          PROJECT_URL="${{ matrix.project.url }}"
          
          curl -H "Cookie: ${{ secrets.COOKIE }}" "$PROJECT_URL" -o "$PROJECT_NAME.zip"
          unzip "./$PROJECT_NAME.zip" -d "./$PROJECT_NAME"

      - name: Fix permissions for caching
        run: |
          sudo mkdir -p /usr/local/texlive/2025
          sudo chown -R $USER:$USER /usr/local/texlive/2025
          sudo chmod -R 755 /usr/local/texlive/2025

      - name: Cache downloaded file
        uses: actions/cache@v4
        id: cache-software
        with:
          path: /usr/local/texlive/2025
          key: ${{ runner.os }}-texlive2025

      - name: install texlive
        if: steps.cache-software.outputs.cache-hit != 'true'
        run: |
          cd /tmp
          curl -O https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/Images/texlive2025.iso
          sudo mkdir -p /mnt/texlive2025
          sudo mount -o loop,ro /tmp/texlive2025.iso /mnt/texlive2025
          cd /mnt/texlive2025
          sudo ./install-tl --scheme=full --no-interaction

      - name: Install fonts
        run: |
          sudo apt update
          sudo apt install -y fonts-noto-cjk fonts-arphic-gkai00mp
          fc-cache -fv

      - name: Compile LaTeX
        run: |
          export PATH=$PATH:/usr/local/texlive/2025/bin/x86_64-linux
          PROJECT_NAME="${{ matrix.project.name }}"
          
          cd "./$PROJECT_NAME"
          
          # 尝试编译
          if [ -f "main.tex" ]; then
            latexmk -xelatex -jobname="$PROJECT_NAME" main.tex
            cp ./*.pdf ../
          fi
          if [ -f "pad.tex" ]; then
            latexmk -xelatex -jobname="${PROJECT_NAME}_pad" pad.tex
            cp ./*.pdf ../
          fi
          if [ -f "exam.tex" ]; then
            latexmk -xelatex -jobname="${PROJECT_NAME}_exam" exam.tex
            cp ./*.pdf ../
          fi
          if [ -f "compile.py" ]; then
            python ./compile.py
            cp ./**/*.pdf ../
          fi

      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.name }}
          path: ./*.pdf
  collect-all-pdfs:
    runs-on: ubuntu-latest
    needs: compile-projects
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-pdfs
          
      - name: List all PDFs
        run: |
          echo "所有编译完成的PDF文件："
          find ./all-pdfs -name "*.pdf" | sort
          
      - name: Create consolidated artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-latex-projects-pdfs
          path: ./all-pdfs/
          retention-days: 7